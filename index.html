<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ï†àÎåÄÍ∞ïÏûê Î©îÎ™®Ïû•</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ========== RESET & BASE ========== */
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { font-size:16px; }
body {
  font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #e8f5e9 0%, #c8e6c9 40%, #a5d6a7 100%);
  min-height: 100vh;
  min-height: 100dvh;
  color: #333;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ========== SCREEN SYSTEM ========== */
.screen { display:none; min-height:100vh; min-height:100dvh; }
.screen.active { display:flex; flex-direction:column; }

/* ========== HOME SCREEN ========== */
#homeScreen {
  padding: 0 0 40px 0;
}
.home-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px 8px;
  position: sticky;
  top: 0;
  z-index: 10;
}
.home-header .icon-btn {
  width: 44px; height: 44px;
  border-radius: 50%;
  background: rgba(255,255,255,0.35);
  backdrop-filter: blur(10px);
  border: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  color: #555;
  cursor: pointer;
  transition: all .2s;
}
.home-header .icon-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.55); }
.home-title {
  text-align: center;
}
.home-title h1 {
  font-size: 22px;
  font-weight: 800;
  color: #2e7d32;
  letter-spacing: -0.5px;
}
.home-title p {
  font-size: 12px;
  color: #558b2f;
  margin-top: 2px;
  font-weight: 400;
}

/* ========== CATEGORY GRID ========== */
.category-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 20px;
  padding: 24px 28px;
  flex: 1;
}
.cat-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}
.cat-card .cat-icon {
  width: 80px; height: 80px;
  border-radius: 22px;
  display: flex; align-items: center; justify-content: center;
  font-size: 32px;
  color: #fff;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
  transition: transform .2s, box-shadow .2s;
  position: relative;
  overflow: hidden;
}
.cat-card .cat-icon::after {
  content: '';
  position: absolute;
  top: -30%; left: -30%;
  width: 60%; height: 60%;
  background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
  border-radius: 50%;
}
.cat-card:active .cat-icon {
  transform: scale(0.92);
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
}
.cat-card .cat-label {
  font-size: 12px;
  font-weight: 500;
  color: #444;
  text-align: center;
  line-height: 1.3;
  word-break: keep-all;
}

/* Add Menu Button */
.cat-card.add-card .cat-icon {
  background: transparent;
  border: 2.5px dashed #aaa;
  color: #999;
  font-size: 28px;
  box-shadow: none;
}
.cat-card.add-card .cat-icon::after { display: none; }
.cat-card.add-card:active .cat-icon { border-color: #777; color: #777; }
.cat-card.add-card .cat-label { color: #888; }

/* Count badge */
.cat-badge {
  position: absolute;
  top: -4px; right: -4px;
  background: #ef4444;
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  min-width: 20px;
  height: 20px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  padding: 0 5px;
  z-index: 2;
  box-shadow: 0 2px 6px rgba(239,68,68,0.4);
}

/* ========== DETAIL SCREEN ========== */
#detailScreen {
  background: #f5f5f5;
}
.detail-header {
  display: flex;
  align-items: center;
  padding: 16px 16px 12px;
  gap: 12px;
  position: sticky;
  top: 0;
  z-index: 10;
  background: #f5f5f5;
  border-bottom: 1px solid #e0e0e0;
}
.detail-header .back-btn {
  width: 40px; height: 40px;
  border-radius: 50%;
  background: rgba(0,0,0,0.06);
  border: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 18px;
  color: #333;
  cursor: pointer;
  flex-shrink: 0;
}
.detail-header .back-btn:active { background: rgba(0,0,0,0.12); }
.detail-header-info {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  min-width: 0;
}
.detail-header-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px;
  color: #fff;
  flex-shrink: 0;
}
.detail-header h2 {
  font-size: 17px;
  font-weight: 700;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.detail-header .header-actions {
  display: flex; gap: 4px; flex-shrink: 0;
}
.detail-header .header-actions button {
  width: 36px; height: 36px;
  border-radius: 50%;
  background: none; border: none;
  display: flex; align-items: center; justify-content: center;
  font-size: 16px; color: #555; cursor: pointer;
}
.detail-header .header-actions button:active { background: rgba(0,0,0,0.06); }

/* Memo List */
.memo-list {
  flex: 1;
  padding: 12px 16px 100px;
  overflow-y: auto;
}
.memo-empty {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 80px 20px;
  color: #aaa;
}
.memo-empty i { font-size: 48px; margin-bottom: 16px; color: #ccc; }
.memo-empty p { font-size: 15px; }

.memo-item {
  background: #fff;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  position: relative;
  transition: transform .15s;
  cursor: pointer;
}
.memo-item:active { transform: scale(0.985); }
.memo-item.pinned { border-left: 3px solid #f59e0b; }
.memo-item .memo-title {
  font-size: 15px;
  font-weight: 600;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.memo-item .memo-title .pin-icon { color: #f59e0b; font-size: 12px; }
.memo-item .memo-content {
  font-size: 13px;
  color: #777;
  line-height: 1.5;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
.memo-item .memo-meta {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 8px;
  font-size: 11px;
  color: #aaa;
}
.memo-item .memo-actions {
  display: flex; gap: 8px;
}
.memo-item .memo-actions button {
  background: none; border: none;
  font-size: 14px; color: #bbb; cursor: pointer; padding: 4px;
}
.memo-item .memo-actions button:hover { color: #777; }
.memo-item .memo-actions .del-btn:hover { color: #ef4444; }

/* Todo checkbox style */
.memo-item.is-todo .memo-title {
  cursor: pointer;
}
.memo-item.is-todo.done .memo-title {
  text-decoration: line-through;
  color: #aaa;
}
.memo-item.is-todo.done .memo-content {
  text-decoration: line-through;
  color: #ccc;
}
.todo-check {
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid #ccc;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-size: 11px; color: transparent;
  transition: all .2s;
  cursor: pointer;
}
.todo-check.checked {
  background: #10b981;
  border-color: #10b981;
  color: #fff;
}

/* FAB */
.fab {
  position: fixed;
  bottom: 28px;
  right: 24px;
  width: 56px; height: 56px;
  border-radius: 50%;
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
  border: none;
  font-size: 24px;
  box-shadow: 0 6px 24px rgba(16,185,129,0.4);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform .2s;
  z-index: 20;
}
.fab:active { transform: scale(0.9); }

/* ========== MODAL ========== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(4px);
  z-index: 100;
  display: none;
  align-items: flex-end;
  justify-content: center;
}
.modal-overlay.active { display: flex; }
.modal {
  background: #fff;
  border-radius: 20px 20px 0 0;
  width: 100%;
  max-width: 500px;
  max-height: 88vh;
  overflow-y: auto;
  padding: 24px 20px 36px;
  animation: slideUp .3s ease;
}
@keyframes slideUp {
  from { transform: translateY(100%); }
  to { transform: translateY(0); }
}
.modal-handle {
  width: 40px; height: 4px;
  background: #ddd;
  border-radius: 2px;
  margin: 0 auto 20px;
}
.modal h3 {
  font-size: 18px;
  font-weight: 700;
  margin-bottom: 20px;
  text-align: center;
}
.form-group {
  margin-bottom: 16px;
}
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #555;
  margin-bottom: 6px;
}
.form-group input,
.form-group textarea,
.form-group select {
  width: 100%;
  padding: 12px 14px;
  border: 1.5px solid #e0e0e0;
  border-radius: 12px;
  font-size: 15px;
  font-family: inherit;
  transition: border-color .2s;
  background: #fafafa;
}
.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  border-color: #10b981;
  background: #fff;
}
.form-group textarea {
  min-height: 120px;
  resize: vertical;
  line-height: 1.6;
}
.form-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
}
.form-actions button {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all .2s;
  border: none;
}
.btn-cancel {
  background: #f3f4f6;
  color: #555;
}
.btn-cancel:active { background: #e5e7eb; }
.btn-save {
  background: linear-gradient(135deg, #10b981, #059669);
  color: #fff;
  box-shadow: 0 4px 14px rgba(16,185,129,0.3);
}
.btn-save:active { transform: scale(0.97); }
.btn-delete {
  background: #fee2e2;
  color: #ef4444;
}
.btn-delete:active { background: #fecaca; }

/* ========== SETTINGS MODAL ========== */
.settings-list {
  list-style: none;
}
.settings-list li {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  font-size: 15px;
}
.settings-list li:active { background: #f9f9f9; }
.settings-list li i {
  width: 24px;
  text-align: center;
  color: #777;
  font-size: 16px;
}

/* ========== ICON PICKER ========== */
.icon-picker-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
  max-height: 250px;
  overflow-y: auto;
  padding: 4px;
}
.icon-pick-item {
  width: 100%; aspect-ratio: 1;
  border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px;
  color: #fff;
  cursor: pointer;
  transition: transform .15s;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.icon-pick-item:active { transform: scale(0.9); }
.icon-pick-item.selected { outline: 3px solid #333; outline-offset: 2px; }

/* Color Picker */
.color-picker-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 10px;
  margin-top: 10px;
}
.color-pick-item {
  width: 100%; aspect-ratio: 1;
  border-radius: 14px;
  cursor: pointer;
  transition: transform .15s;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
}
.color-pick-item:active { transform: scale(0.9); }
.color-pick-item.selected { outline: 3px solid #333; outline-offset: 2px; }

/* ========== SEARCH BAR ========== */
.search-bar {
  padding: 0 16px 8px;
  display: none;
}
.search-bar.active { display: block; }
.search-bar input {
  width: 100%;
  padding: 10px 14px 10px 38px;
  border: 1.5px solid #e0e0e0;
  border-radius: 12px;
  font-size: 14px;
  font-family: inherit;
  background: #fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23aaa' viewBox='0 0 24 24' width='16' height='16'%3E%3Cpath d='M15.5 14h-.79l-.28-.27A6.47 6.47 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z'/%3E%3C/svg%3E") 12px center no-repeat;
}
.search-bar input:focus { outline:none; border-color: #10b981; }

/* ========== TOAST ========== */
.toast {
  position: fixed;
  bottom: 100px;
  left: 50%; transform: translateX(-50%);
  background: rgba(0,0,0,0.8);
  color: #fff;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 14px;
  z-index: 200;
  opacity: 0;
  transition: opacity .3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* ========== RESPONSIVE ========== */
@media (min-width: 500px) {
  body { display:flex; justify-content:center; }
  .screen { max-width: 480px; width: 100%; }
  .modal { max-width: 480px; }
}
</style>
</head>
<body>

<!-- ===== HOME SCREEN ===== -->
<div id="homeScreen" class="screen active">
  <div class="home-header">
    <button class="icon-btn" onclick="openSettings()">
      <i class="fa-solid fa-gear"></i>
    </button>
    <div class="home-title">
      <h1>Ï†àÎåÄÍ∞ïÏûê Î©îÎ™®Ïû•</h1>
      <p>Î™®Îì† Í∏∞Î°ùÏùÑ Ìïú Í≥≥ÏóêÏÑú Í∞ÑÌé∏ÌïòÍ≤å</p>
    </div>
    <button class="icon-btn" onclick="syncData()">
      <i class="fa-solid fa-cloud"></i>
    </button>
  </div>
  <div class="category-grid" id="categoryGrid">
    <!-- Rendered by JS -->
  </div>
</div>

<!-- ===== DETAIL SCREEN ===== -->
<div id="detailScreen" class="screen">
  <div class="detail-header">
    <button class="back-btn" onclick="goHome()">
      <i class="fa-solid fa-arrow-left"></i>
    </button>
    <div class="detail-header-info">
      <div class="detail-header-icon" id="detailIcon"></div>
      <h2 id="detailTitle"></h2>
    </div>
    <div class="header-actions">
      <button onclick="toggleSearch()"><i class="fa-solid fa-search"></i></button>
      <button onclick="openSortMenu()"><i class="fa-solid fa-ellipsis-vertical"></i></button>
    </div>
  </div>
  <div class="search-bar" id="searchBar">
    <input type="text" id="searchInput" placeholder="Î©îÎ™® Í≤ÄÏÉâ..." oninput="filterMemos()">
  </div>
  <div class="memo-list" id="memoList"></div>
  <button class="fab" onclick="openMemoModal()">
    <i class="fa-solid fa-plus"></i>
  </button>
</div>

<!-- ===== MEMO MODAL ===== -->
<div class="modal-overlay" id="memoModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="memoModalTitle">ÏÉà Î©îÎ™®</h3>
    <div class="form-group">
      <label>Ï†úÎ™©</label>
      <input type="text" id="memoTitleInput" placeholder="Î©îÎ™® Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
    </div>
    <div class="form-group">
      <label>ÎÇ¥Ïö©</label>
      <textarea id="memoContentInput" placeholder="ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
    </div>
    <div class="form-group" id="memoDateGroup">
      <label>ÎÇ†Ïßú</label>
      <input type="date" id="memoDateInput">
    </div>
    <div class="form-group" style="display:flex; align-items:center; gap:10px;">
      <label style="margin:0">üìå ÏÉÅÎã® Í≥†Ï†ï</label>
      <input type="checkbox" id="memoPinnedInput" style="width:20px;height:20px;">
    </div>
    <div class="form-actions" id="memoFormActions">
      <button class="btn-cancel" onclick="closeMemoModal()">Ï∑®ÏÜå</button>
      <button class="btn-save" onclick="saveMemo()">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<!-- ===== CATEGORY ADD/EDIT MODAL ===== -->
<div class="modal-overlay" id="catModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3 id="catModalTitle">Î©îÎâ¥ Ï∂îÍ∞Ä</h3>
    <div class="form-group">
      <label>Î©îÎâ¥ Ïù¥Î¶Ñ</label>
      <input type="text" id="catNameInput" placeholder="Ïπ¥ÌÖåÍ≥†Î¶¨ Ïù¥Î¶Ñ" maxlength="10">
    </div>
    <div class="form-group">
      <label>ÏïÑÏù¥ÏΩò ÏÑ†ÌÉù</label>
      <div class="icon-picker-grid" id="iconPicker"></div>
    </div>
    <div class="form-group">
      <label>ÏÉâÏÉÅ ÏÑ†ÌÉù</label>
      <div class="color-picker-grid" id="colorPicker"></div>
    </div>
    <div class="form-actions" id="catFormActions">
      <button class="btn-cancel" onclick="closeCatModal()">Ï∑®ÏÜå</button>
      <button class="btn-save" onclick="saveCategory()">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<!-- ===== SETTINGS MODAL ===== -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <h3>ÏÑ§Ï†ï</h3>
    <ul class="settings-list">
      <li onclick="exportData()"><i class="fa-solid fa-download"></i> Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ (JSON)</li>
      <li onclick="document.getElementById('importFile').click()"><i class="fa-solid fa-upload"></i> Îç∞Ïù¥ÌÑ∞ Î≥µÏõê</li>
      <li onclick="clearAllData()"><i class="fa-solid fa-trash-can" style="color:#ef4444"></i> <span style="color:#ef4444">Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú</span></li>
    </ul>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    <div class="form-actions" style="margin-top:24px;">
      <button class="btn-cancel" onclick="closeSettings()" style="flex:1">Îã´Í∏∞</button>
    </div>
  </div>
</div>

<!-- ===== TOAST ===== -->
<div class="toast" id="toast"></div>

<script>
/* ========================================
   Ï†àÎåÄÍ∞ïÏûê Î©îÎ™®Ïû• - Single File App
   ======================================== */

// ---- STATE ----
let categories = [];
let memos = [];
let currentCategoryId = null;
let editingMemoId = null;
let editingCatId = null;
let selectedIcon = 'fa-solid fa-star';
let selectedGradient = 'linear-gradient(135deg, #7B68EE, #9B89F5)';

// ---- AVAILABLE ICONS & COLORS ----
const ICONS = [
  'fa-solid fa-comment-dots', 'fa-solid fa-square-check', 'fa-solid fa-calendar-days',
  'fa-solid fa-plane', 'fa-solid fa-utensils', 'fa-solid fa-hospital',
  'fa-solid fa-globe', 'fa-solid fa-building-columns', 'fa-solid fa-masks-theater',
  'fa-solid fa-user-group', 'fa-solid fa-star', 'fa-solid fa-heart',
  'fa-solid fa-book', 'fa-solid fa-music', 'fa-solid fa-camera',
  'fa-solid fa-gamepad', 'fa-solid fa-car', 'fa-solid fa-house',
  'fa-solid fa-briefcase', 'fa-solid fa-graduation-cap', 'fa-solid fa-dumbbell',
  'fa-solid fa-palette', 'fa-solid fa-code', 'fa-solid fa-pills',
  'fa-solid fa-dog', 'fa-solid fa-shirt', 'fa-solid fa-gift',
  'fa-solid fa-phone', 'fa-solid fa-lightbulb', 'fa-solid fa-cart-shopping'
];

const GRADIENTS = [
  'linear-gradient(135deg, #7B68EE, #9B89F5)',
  'linear-gradient(135deg, #F472B6, #FB923C)',
  'linear-gradient(135deg, #9CA3AF, #D1D5DB)',
  'linear-gradient(135deg, #F97316, #06B6D4)',
  'linear-gradient(135deg, #F59E0B, #F97316)',
  'linear-gradient(135deg, #3B82F6, #10B981)',
  'linear-gradient(135deg, #34D399, #059669)',
  'linear-gradient(135deg, #10B981, #047857)',
  'linear-gradient(135deg, #FB923C, #F472B6)',
  'linear-gradient(135deg, #F97316, #84CC16)',
  'linear-gradient(135deg, #8B5CF6, #EC4899)',
  'linear-gradient(135deg, #EF4444, #F97316)',
  'linear-gradient(135deg, #3B82F6, #8B5CF6)',
  'linear-gradient(135deg, #06B6D4, #3B82F6)',
  'linear-gradient(135deg, #14B8A6, #A78BFA)'
];

// ---- API HELPERS ----
const API = {
  async getCategories() {
    const res = await fetch('tables/categories?limit=100&sort=sort_order');
    const data = await res.json();
    return data.data || [];
  },
  async getMemos(categoryId) {
    const res = await fetch(`tables/memos?limit=200&search=${encodeURIComponent(categoryId)}`);
    const data = await res.json();
    return (data.data || []).filter(m => m.category_id === categoryId);
  },
  async getAllMemos() {
    const res = await fetch('tables/memos?limit=1000');
    const data = await res.json();
    return data.data || [];
  },
  async createCategory(cat) {
    const res = await fetch('tables/categories', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(cat)
    });
    return await res.json();
  },
  async updateCategory(id, cat) {
    const res = await fetch(`tables/categories/${id}`, {
      method: 'PUT', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(cat)
    });
    return await res.json();
  },
  async deleteCategory(id) {
    await fetch(`tables/categories/${id}`, { method: 'DELETE' });
  },
  async createMemo(memo) {
    const res = await fetch('tables/memos', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(memo)
    });
    return await res.json();
  },
  async updateMemo(id, memo) {
    const res = await fetch(`tables/memos/${id}`, {
      method: 'PATCH', headers: {'Content-Type':'application/json'},
      body: JSON.stringify(memo)
    });
    return await res.json();
  },
  async deleteMemo(id) {
    await fetch(`tables/memos/${id}`, { method: 'DELETE' });
  }
};

// ---- INIT ----
async function init() {
  await loadCategories();
  renderHome();
}

async function loadCategories() {
  try {
    categories = await API.getCategories();
  } catch(e) {
    console.error('Failed to load categories:', e);
    categories = [];
  }
}

// ---- HOME RENDERING ----
async function renderHome() {
  const grid = document.getElementById('categoryGrid');
  // Load memo counts
  let allMemos = [];
  try { allMemos = await API.getAllMemos(); } catch(e) {}
  const countMap = {};
  allMemos.forEach(m => {
    countMap[m.category_id] = (countMap[m.category_id] || 0) + 1;
  });

  let html = '';
  const sorted = [...categories].sort((a,b) => (a.sort_order||0) - (b.sort_order||0));
  sorted.forEach(cat => {
    const count = countMap[cat.id] || 0;
    html += `
      <div class="cat-card" onclick="openCategory('${cat.id}')" oncontextmenu="editCategory(event,'${cat.id}')">
        <div class="cat-icon" style="background:${cat.gradient}">
          ${count > 0 ? `<span class="cat-badge">${count}</span>` : ''}
          <i class="${cat.icon}"></i>
        </div>
        <span class="cat-label">${escHtml(cat.name)}</span>
      </div>
    `;
  });
  // Add button
  html += `
    <div class="cat-card add-card" onclick="openCatModal()">
      <div class="cat-icon">
        <i class="fa-solid fa-plus"></i>
      </div>
      <span class="cat-label">Î©îÎâ¥<br>Ï∂îÍ∞Ä</span>
    </div>
  `;
  grid.innerHTML = html;
}

// ---- CATEGORY DETAIL ----
async function openCategory(catId) {
  currentCategoryId = catId;
  const cat = categories.find(c => c.id === catId);
  if (!cat) return;

  document.getElementById('detailIcon').style.background = cat.gradient;
  document.getElementById('detailIcon').innerHTML = `<i class="${cat.icon}" style="color:#fff;font-size:16px"></i>`;
  document.getElementById('detailTitle').textContent = cat.name;

  showScreen('detailScreen');
  await loadMemos();
}

async function loadMemos() {
  try {
    memos = await API.getMemos(currentCategoryId);
  } catch(e) {
    memos = [];
  }
  renderMemos(memos);
}

function renderMemos(list) {
  const container = document.getElementById('memoList');
  const cat = categories.find(c => c.id === currentCategoryId);
  const isTodo = cat && cat.name.includes('Ìï†Ïùº');

  if (!list || list.length === 0) {
    container.innerHTML = `
      <div class="memo-empty">
        <i class="fa-regular fa-folder-open"></i>
        <p>Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§</p>
        <p style="font-size:13px;margin-top:8px;color:#ccc">+ Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>
      </div>
    `;
    return;
  }

  // Sort: pinned first, then by updated_at desc
  const sorted = [...list].sort((a,b) => {
    if (a.pinned && !b.pinned) return -1;
    if (!a.pinned && b.pinned) return 1;
    return (b.updated_at || 0) - (a.updated_at || 0);
  });

  let html = '';
  sorted.forEach(memo => {
    const dateStr = memo.memo_date ? formatDate(memo.memo_date) : formatDate(memo.created_at);
    const doneClass = (isTodo && memo.is_done) ? ' done' : '';
    const todoClass = isTodo ? ' is-todo' : '';

    html += `
      <div class="memo-item${memo.pinned ? ' pinned' : ''}${todoClass}${doneClass}" onclick="openMemoModal('${memo.id}')">
        <div class="memo-title">
          ${isTodo ? `<span class="todo-check${memo.is_done ? ' checked' : ''}" onclick="event.stopPropagation();toggleTodo('${memo.id}')"><i class="fa-solid fa-check"></i></span>` : ''}
          ${memo.pinned ? '<i class="fa-solid fa-thumbtack pin-icon"></i>' : ''}
          ${escHtml(memo.title || 'Ï†úÎ™© ÏóÜÏùå')}
        </div>
        ${memo.content ? `<div class="memo-content">${escHtml(stripHtml(memo.content))}</div>` : ''}
        <div class="memo-meta">
          <span>${dateStr}</span>
          <div class="memo-actions">
            <button onclick="event.stopPropagation();deleteMemo('${memo.id}')" class="del-btn"><i class="fa-solid fa-trash-can"></i></button>
          </div>
        </div>
      </div>
    `;
  });
  container.innerHTML = html;
}

// ---- MEMO CRUD ----
function openMemoModal(memoId) {
  editingMemoId = memoId || null;
  const modal = document.getElementById('memoModal');
  const titleEl = document.getElementById('memoModalTitle');
  const titleInput = document.getElementById('memoTitleInput');
  const contentInput = document.getElementById('memoContentInput');
  const dateInput = document.getElementById('memoDateInput');
  const pinnedInput = document.getElementById('memoPinnedInput');
  const actions = document.getElementById('memoFormActions');

  if (memoId) {
    const memo = memos.find(m => m.id === memoId);
    if (!memo) return;
    titleEl.textContent = 'Î©îÎ™® ÏàòÏ†ï';
    titleInput.value = memo.title || '';
    contentInput.value = stripHtml(memo.content || '');
    dateInput.value = memo.memo_date ? toDateValue(memo.memo_date) : '';
    pinnedInput.checked = !!memo.pinned;
    actions.innerHTML = `
      <button class="btn-delete" onclick="deleteMemo('${memoId}');closeMemoModal()">ÏÇ≠Ï†ú</button>
      <button class="btn-cancel" onclick="closeMemoModal()">Ï∑®ÏÜå</button>
      <button class="btn-save" onclick="saveMemo()">Ï†ÄÏû•</button>
    `;
  } else {
    titleEl.textContent = 'ÏÉà Î©îÎ™®';
    titleInput.value = '';
    contentInput.value = '';
    dateInput.value = new Date().toISOString().slice(0,10);
    pinnedInput.checked = false;
    actions.innerHTML = `
      <button class="btn-cancel" onclick="closeMemoModal()">Ï∑®ÏÜå</button>
      <button class="btn-save" onclick="saveMemo()">Ï†ÄÏû•</button>
    `;
  }
  modal.classList.add('active');
  setTimeout(() => titleInput.focus(), 300);
}

function closeMemoModal() {
  document.getElementById('memoModal').classList.remove('active');
  editingMemoId = null;
}

async function saveMemo() {
  const title = document.getElementById('memoTitleInput').value.trim();
  const content = document.getElementById('memoContentInput').value.trim();
  const memoDate = document.getElementById('memoDateInput').value;
  const pinned = document.getElementById('memoPinnedInput').checked;

  if (!title && !content) {
    showToast('Ï†úÎ™©Ïù¥ÎÇò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
    return;
  }

  const data = {
    category_id: currentCategoryId,
    title: title || 'Ï†úÎ™© ÏóÜÏùå',
    content: content,
    memo_date: memoDate || null,
    pinned: pinned,
    is_done: false
  };

  try {
    if (editingMemoId) {
      await API.updateMemo(editingMemoId, data);
      showToast('Î©îÎ™®Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
    } else {
      await API.createMemo(data);
      showToast('Î©îÎ™®Í∞Ä Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
    }
    closeMemoModal();
    await loadMemos();
  } catch(e) {
    showToast('Ï†ÄÏû• Ïã§Ìå®: ' + e.message);
  }
}

async function deleteMemo(id) {
  if (!confirm('Ïù¥ Î©îÎ™®Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
  try {
    await API.deleteMemo(id);
    showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
    await loadMemos();
  } catch(e) {
    showToast('ÏÇ≠Ï†ú Ïã§Ìå®');
  }
}

async function toggleTodo(id) {
  const memo = memos.find(m => m.id === id);
  if (!memo) return;
  try {
    await API.updateMemo(id, { is_done: !memo.is_done });
    await loadMemos();
  } catch(e) {
    showToast('ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®');
  }
}

// ---- CATEGORY CRUD ----
function openCatModal(catId) {
  editingCatId = catId || null;
  const modal = document.getElementById('catModal');
  const titleEl = document.getElementById('catModalTitle');
  const nameInput = document.getElementById('catNameInput');
  const actions = document.getElementById('catFormActions');

  renderIconPicker();
  renderColorPicker();

  if (catId) {
    const cat = categories.find(c => c.id === catId);
    if (!cat) return;
    titleEl.textContent = 'Î©îÎâ¥ ÏàòÏ†ï';
    nameInput.value = cat.name;
    selectedIcon = cat.icon;
    selectedGradient = cat.gradient;
    actions.innerHTML = `
      <button class="btn-delete" onclick="deleteCategory('${catId}')">ÏÇ≠Ï†ú</button>
      <button class="btn-cancel" onclick="closeCatModal()">Ï∑®ÏÜå</button>
      <button class="btn-save" onclick="saveCategory()">Ï†ÄÏû•</button>
    `;
  } else {
    titleEl.textContent = 'Î©îÎâ¥ Ï∂îÍ∞Ä';
    nameInput.value = '';
    selectedIcon = 'fa-solid fa-star';
    selectedGradient = GRADIENTS[0];
    actions.innerHTML = `
      <button class="btn-cancel" onclick="closeCatModal()">Ï∑®ÏÜå</button>
      <button class="btn-save" onclick="saveCategory()">Ï†ÄÏû•</button>
    `;
  }

  renderIconPicker();
  renderColorPicker();
  modal.classList.add('active');
  setTimeout(() => nameInput.focus(), 300);
}

function closeCatModal() {
  document.getElementById('catModal').classList.remove('active');
  editingCatId = null;
}

function renderIconPicker() {
  const grid = document.getElementById('iconPicker');
  grid.innerHTML = ICONS.map(icon => `
    <div class="icon-pick-item ${icon === selectedIcon ? 'selected' : ''}"
         style="background:${selectedGradient}"
         onclick="selectIcon('${icon}')">
      <i class="${icon}"></i>
    </div>
  `).join('');
}

function renderColorPicker() {
  const grid = document.getElementById('colorPicker');
  grid.innerHTML = GRADIENTS.map(g => `
    <div class="color-pick-item ${g === selectedGradient ? 'selected' : ''}"
         style="background:${g}"
         onclick="selectGradient(this, \`${g}\`)">
    </div>
  `).join('');
}

function selectIcon(icon) {
  selectedIcon = icon;
  renderIconPicker();
}

function selectGradient(el, gradient) {
  selectedGradient = gradient;
  renderColorPicker();
  renderIconPicker(); // update icon preview colors
}

async function saveCategory() {
  const name = document.getElementById('catNameInput').value.trim();
  if (!name) {
    showToast('Î©îÎâ¥ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
    return;
  }

  const data = {
    name: name,
    icon: selectedIcon,
    gradient: selectedGradient,
    sort_order: editingCatId
      ? (categories.find(c => c.id === editingCatId)?.sort_order || categories.length + 1)
      : categories.length + 1
  };

  try {
    if (editingCatId) {
      await API.updateCategory(editingCatId, data);
      showToast('Î©îÎâ¥Í∞Ä ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§');
    } else {
      await API.createCategory(data);
      showToast('Î©îÎâ¥Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§');
    }
    closeCatModal();
    await loadCategories();
    renderHome();
  } catch(e) {
    showToast('Ï†ÄÏû• Ïã§Ìå®: ' + e.message);
  }
}

async function deleteCategory(id) {
  if (!confirm('Ïù¥ Î©îÎâ¥ÏôÄ Í¥ÄÎ†®Îêú Î™®Îì† Î©îÎ™®Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
  try {
    // Delete all memos in this category
    const catMemos = await API.getMemos(id);
    for (const m of catMemos) {
      await API.deleteMemo(m.id);
    }
    await API.deleteCategory(id);
    showToast('Î©îÎâ¥Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
    closeCatModal();
    await loadCategories();
    renderHome();
  } catch(e) {
    showToast('ÏÇ≠Ï†ú Ïã§Ìå®');
  }
}

function editCategory(e, catId) {
  e.preventDefault();
  openCatModal(catId);
}

// ---- SEARCH ----
function toggleSearch() {
  const bar = document.getElementById('searchBar');
  bar.classList.toggle('active');
  if (bar.classList.contains('active')) {
    document.getElementById('searchInput').focus();
  } else {
    document.getElementById('searchInput').value = '';
    renderMemos(memos);
  }
}

function filterMemos() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  if (!query) {
    renderMemos(memos);
    return;
  }
  const filtered = memos.filter(m =>
    (m.title || '').toLowerCase().includes(query) ||
    (m.content || '').toLowerCase().includes(query)
  );
  renderMemos(filtered);
}

// ---- SORT ----
function openSortMenu() {
  // Simple sort toggle via prompt
  const choice = prompt('Ï†ïÎ†¨ Í∏∞Ï§ÄÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:\n1. ÏµúÏã†Ïàú\n2. Ïò§ÎûòÎêúÏàú\n3. Ï†úÎ™©Ïàú\n4. Í≥†Ï†ï Ïö∞ÏÑ†', '1');
  if (!choice) return;
  let sorted = [...memos];
  switch(choice) {
    case '1': sorted.sort((a,b) => (b.updated_at||0) - (a.updated_at||0)); break;
    case '2': sorted.sort((a,b) => (a.updated_at||0) - (b.updated_at||0)); break;
    case '3': sorted.sort((a,b) => (a.title||'').localeCompare(b.title||'')); break;
    case '4': sorted.sort((a,b) => (b.pinned?1:0) - (a.pinned?1:0)); break;
  }
  renderMemos(sorted);
}

// ---- SETTINGS ----
function openSettings() {
  document.getElementById('settingsModal').classList.add('active');
}
function closeSettings() {
  document.getElementById('settingsModal').classList.remove('active');
}

async function exportData() {
  try {
    const cats = await API.getCategories();
    const allMemos = await API.getAllMemos();
    const data = { categories: cats, memos: allMemos, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `Î©îÎ™®Ïû•_Î∞±ÏóÖ_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    showToast('Î∞±ÏóÖ ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎê©ÎãàÎã§');
  } catch(e) {
    showToast('Î∞±ÏóÖ Ïã§Ìå®');
  }
}

async function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    const text = await file.text();
    const data = JSON.parse(text);
    if (!data.categories || !data.memos) throw new Error('Invalid format');

    if (!confirm(`Ïπ¥ÌÖåÍ≥†Î¶¨ ${data.categories.length}Í∞ú, Î©îÎ™® ${data.memos.length}Í∞úÎ•º Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;

    for (const cat of data.categories) {
      await API.createCategory({ name: cat.name, icon: cat.icon, gradient: cat.gradient, sort_order: cat.sort_order });
    }
    // Re-load categories to get new IDs
    await loadCategories();
    // Map old category IDs to new ones by name
    const catMap = {};
    data.categories.forEach((oldCat, i) => {
      const newCat = categories.find(c => c.name === oldCat.name);
      if (newCat) catMap[oldCat.id] = newCat.id;
    });

    for (const memo of data.memos) {
      const newCatId = catMap[memo.category_id] || memo.category_id;
      await API.createMemo({
        category_id: newCatId,
        title: memo.title,
        content: memo.content,
        memo_date: memo.memo_date,
        pinned: memo.pinned,
        is_done: memo.is_done
      });
    }

    showToast('Î≥µÏõê ÏôÑÎ£å!');
    closeSettings();
    await loadCategories();
    renderHome();
  } catch(e) {
    showToast('Î≥µÏõê Ïã§Ìå®: Ïò¨Î∞îÎ•∏ ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§');
  }
  event.target.value = '';
}

async function clearAllData() {
  if (!confirm('Ï†ïÎßê Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.')) return;
  if (!confirm('ÎßàÏßÄÎßâ ÌôïÏù∏: Î™®Îì† Î©îÎ™®ÏôÄ Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§.')) return;
  try {
    const allMemos = await API.getAllMemos();
    for (const m of allMemos) await API.deleteMemo(m.id);
    for (const c of categories) await API.deleteCategory(c.id);
    categories = [];
    showToast('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
    closeSettings();
    renderHome();
  } catch(e) {
    showToast('ÏÇ≠Ï†ú Ïã§Ìå®');
  }
}

function syncData() {
  showToast('ÌÅ¥ÎùºÏö∞ÎìúÏôÄ ÎèôÍ∏∞Ìôî Ï§ë...');
  setTimeout(async () => {
    await loadCategories();
    renderHome();
    showToast('ÎèôÍ∏∞Ìôî ÏôÑÎ£å!');
  }, 500);
}

// ---- NAVIGATION ----
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goHome() {
  currentCategoryId = null;
  document.getElementById('searchBar').classList.remove('active');
  document.getElementById('searchInput').value = '';
  showScreen('homeScreen');
  renderHome();
}

// ---- UTILITIES ----
function escHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function stripHtml(s) {
  return s ? s.replace(/<[^>]*>/g, '') : '';
}

function formatDate(d) {
  if (!d) return '';
  const date = new Date(d);
  if (isNaN(date.getTime())) return d;
  return `${date.getFullYear()}.${String(date.getMonth()+1).padStart(2,'0')}.${String(date.getDate()).padStart(2,'0')}`;
}

function toDateValue(d) {
  if (!d) return '';
  const date = new Date(d);
  if (isNaN(date.getTime())) return '';
  return date.toISOString().slice(0,10);
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('active');
    }
  });
});

// Handle back button
window.addEventListener('popstate', () => {
  if (currentCategoryId) {
    goHome();
  }
});

// ---- START ----
init();
</script>
</body>
</html>
